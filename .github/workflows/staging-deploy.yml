name: Deploy to Staging

on:
  push:
    branches: [ develop ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    environment: staging
    if: github.ref == 'refs/heads/develop' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=sha,prefix=staging-

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}

    - name: Deploy to Staging Server
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.STAGING_SERVER_SSH_KEY }}
      
    - name: Deploy Application
      env:
        STAGING_HOST: ${{ secrets.STAGING_SERVER_HOST }}
        STAGING_USER: ${{ secrets.STAGING_SERVER_USER }}
        IMAGE_TAG: ${{ steps.meta.outputs.tags }}
      run: |
        ssh -o StrictHostKeyChecking=no $STAGING_USER@$STAGING_HOST << 'EOF'
          cd /opt/nflplayoffpool-staging
          
          # Update environment for staging
          cat > .env << ENVEOF
        ASPNETCORE_ENVIRONMENT=Staging
        WEBAPP_PORT=8080
        MONGODB_PORT=27018
        MONGODB_DATABASE=playoff_pool_staging
        MONGODB_ROOT_PASSWORD=${{ secrets.STAGING_MONGODB_PASSWORD }}
        MONGODB_DATA_PATH=/opt/nflplayoffpool-staging/data/mongodb
        ADMIN_EMAIL=${{ secrets.STAGING_ADMIN_EMAIL }}
        ADMIN_PASSWORD=${{ secrets.STAGING_ADMIN_PASSWORD }}
        ADMIN_FIRST_NAME=Staging
        ADMIN_LAST_NAME=Admin
        CONTAINER_IMAGE=$IMAGE_TAG
        ENVEOF
          
          # Deploy
          docker-compose pull webapp
          docker-compose up -d
          
          # Health check
          sleep 30
          curl -f http://localhost:8080/health
        EOF